name: Daily Commit Report

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM IST
  workflow_dispatch:

jobs:
  commit-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Run Commit Reporter Script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          python <<EOF
          import os
          import requests
          from datetime import datetime, timedelta

          GH_TOKEN = os.getenv("GH_TOKEN")
          TEAMS_WEBHOOK_URL = os.getenv("TEAMS_WEBHOOK_URL")

          headers = {
              "Authorization": f"Bearer {GH_TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          since = (datetime.utcnow() - timedelta(days=1)).isoformat() + "Z"

          with open("repos.txt", "r") as f:
              repos = [line.strip() for line in f if line.strip()]

          report_lines = []

          for repo in repos:
              owner, name = repo.split("/")
              branches_url = f"https://api.github.com/repos/{owner}/{name}/branches"
              r = requests.get(branches_url, headers=headers)
              branches = r.json()

              if not isinstance(branches, list):
                  report_lines.append(f"### ğŸ“ {repo}\nâš ï¸ Could not fetch branches.\n")
                  continue

              branch_commit_lines = []
              seen = set()

              for branch in branches:
                  branch_name = branch['name']
                  commits_url = f"https://api.github.com/repos/{owner}/{name}/commits?sha={branch_name}&since={since}"
                  r = requests.get(commits_url, headers=headers)
                  commits = r.json()

                  if not isinstance(commits, list):
                      continue

                  for commit in commits:
                      sha = commit['sha']
                      key = f"{sha}-{branch_name}"
                      if key in seen:
                          continue
                      seen.add(key)

                      msg = commit['commit']['message'].splitlines()[0]
                      url = commit['html_url']
                      author = commit['commit']['author']['name']

                      # Get file changes
                      details_url = f"https://api.github.com/repos/{owner}/{name}/commits/{sha}"
                      details_r = requests.get(details_url, headers=headers)
                      files_changed = []

                      if details_r.status_code == 200:
                          commit_details = details_r.json()
                          files_changed = [f['filename'] for f in commit_details.get('files', [])]

                      file_list = ', '.join(files_changed) if files_changed else 'No files listed'

                      branch_commit_lines.append(
                          f"- **{msg[:50] + '...' if len(msg) > 50 else msg}**\n"
                          f"  ğŸ‘¤ Author: {author}\n"
                          f"  ğŸŒ¿ Branch: {branch_name}\n"
                          f"  ğŸ—‚ï¸ Files: {file_list}\n"
                          f"  ğŸ”— [View Commit]({url})\n"
                      )

              if not branch_commit_lines:
                  report_lines.append(f"### ğŸ“ {repo}\n_No commits in the last 24 hours._\n")
              else:
                  report_lines.append(f"### ğŸ“ {repo}")
                  report_lines.extend(branch_commit_lines)
                  report_lines.append("")  # spacing

          final_message = f"ğŸ“Š **GitHub Daily Commit Report** ({datetime.utcnow().date()})\n\n" + "\n".join(report_lines)

          payload = {
              "text": final_message
          }

          response = requests.post(TEAMS_WEBHOOK_URL, json=payload)
          if response.status_code != 200:
              print(f"âŒ Failed to send message: {response.status_code}\n{response.text}")
          else:
              print("âœ… Report sent successfully.")
          EOF
