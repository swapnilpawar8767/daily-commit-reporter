name: Daily Commit Report

on:
  schedule:
    - cron: '0 6 * * *'  # Runs daily at 6 AM IST (~12:30 AM UTC)
  workflow_dispatch:

jobs:
  commit-report:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: pip install requests

      - name: Run Commit Reporter Script
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        run: |
          python <<EOF
          import os
          import requests
          from datetime import datetime, timedelta

          GH_TOKEN = os.getenv("GH_TOKEN")
          TEAMS_WEBHOOK_URL = os.getenv("TEAMS_WEBHOOK_URL")

          headers = {
              "Authorization": f"Bearer {GH_TOKEN}",
              "Accept": "application/vnd.github+json"
          }

          since = (datetime.utcnow() - timedelta(days=1)).isoformat() + "Z"

          with open("repos.txt", "r") as f:
              repos = [line.strip() for line in f if line.strip()]

          report_lines = []

          for repo in repos:
              owner, name = repo.split("/")

              # Step 1: Get branches
              branches_url = f"https://api.github.com/repos/{owner}/{name}/branches"
              r = requests.get(branches_url, headers=headers)
              branches = r.json()

              if not isinstance(branches, list):
                  report_lines.append(f"### ðŸ“ {repo}\nâš ï¸ Could not fetch branches.\n")
                  continue

              all_commits = {}
              for branch in branches:
                  branch_name = branch['name']
                  commits_url = f"https://api.github.com/repos/{owner}/{name}/commits?sha={branch_name}&since={since}"
                  r = requests.get(commits_url, headers=headers)
                  branch_commits = r.json()

                  if not isinstance(branch_commits, list):
                      continue

                  for commit in branch_commits:
                      sha = commit['sha']
                      if sha not in all_commits:
                          all_commits[sha] = {
                              'message': commit['commit']['message'].splitlines()[0],
                              'author': commit['commit']['author']['name'],
                              'url': commit['html_url'],
                              'branch': branch_name
                          }

              if not all_commits:
                  report_lines.append(f"### ðŸ“ {repo}\n_No commits in the last 24 hours._\n")
                  continue

              report_lines.append(f"### ðŸ“ {repo}")
              for commit in all_commits.values():
                  report_lines.append(f"- [{commit['message']}]({commit['url']}) by **{commit['author']}** on `{commit['branch']}`")
              report_lines.append("")

          final_message = f"ðŸ“Š **GitHub Daily Commit Report** ({datetime.utcnow().date()})\n\n" + "\n".join(report_lines)

          payload = {
              "text": final_message
          }

          r = requests.post(TEAMS_WEBHOOK_URL, json=payload)
          if r.status_code != 200:
              print(f"Failed to send message: {r.status_code} - {r.text}")
          EOF
